image: mcr.microsoft.com/dotnet/core/sdk:3.1

variables:
  # Set $NUGET_SERVER_URL and $NUGET_API_KEY in project settings
  SRC: src
  DOCS: docs
  NUGET_PACKAGES_DIRECTORY: .nuget

stages:
  - build
  - test
  - deploy

cache:
  key:
    files:
      - $SRC/*.csproj
  paths:
    - $NUGET_PACKAGES_DIRECTORY
    - $DOCS/api/

before_script:
  - dotnet restore $SRC/ --packages $NUGET_PACKAGES_DIRECTORY

build:
  stage: build
  script: 
    - dotnet build $SRC/ --no-restore

test:
  stage: test
  script:
    - dotnet test $SRC/ --no-restore

publish:
  stage: deploy
  only:
    - master
  script:
    - dotnet pack $SRC/ -c Release -o packages/ --version-suffix ci.$CI_PIPELINE_ID+git.$CI_COMMIT_SHA --no-restore
    - dotnet nuget push packages/*.nupkg -s $NUGET_SERVER_URL -k $NUGET_API_KEY
  artifacts:
    paths:
      - packages/

pages:
  # DocFX with Mono, .NET Core 3.1 SDK
  image: tizendotnet/tizenfx-build-worker:2.0
  stage: deploy
  only:
    - master
  before_script:
    - ''
  script:
    - docfx $DOCS/docfx.json
  artifacts:
    paths:
      - public/
