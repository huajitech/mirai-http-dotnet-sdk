image: mcr.microsoft.com/dotnet/core/sdk:3.1

variables:
  # Set $NUGET_SERVER_URL and $NUGET_API_KEY in project settings
  NUGET_PACKAGES_DIRECTORY: .nuget
  CONFIGURATION: Release

stages:
  - build
  - pack
  - deploy

cache:
  key:
    files:
      - src/*.csproj
  paths:
    - $NUGET_PACKAGES_DIRECTORY

before_script:
  - dotnet restore src/ --packages $NUGET_PACKAGES_DIRECTORY

build:
  stage: build
  only:
    changes:
      - src/**/*
  script: 
    - dotnet build src/ -c $CONFIGURATION -p:GenerateDocumentationFile=true --no-restore
  artifacts:
    paths:
      - src/bin/

pack:
  stage: pack
  only:
    changes:
      - src/**/*
  needs:
    - job: build
      artifacts: true
  script:
    - dotnet pack src/ -o packages/ -c $CONFIGURATION --version-suffix ci.$CI_PIPELINE_ID+git.$CI_COMMIT_SHA -p:GenerateDocumentationFile=true --no-build
  artifacts:
    paths:
      - packages/

publish:
  stage: deploy
  only:
    refs:
      - master
    changes:
      - src/**/*
    variables:
      - $NUGET_SERVER_URL
      - $NUGET_API_KEY
  needs:
    - job: pack
      artifacts: true
  script:
    - dotnet nuget push packages/*.nupkg -s $NUGET_SERVER_URL -k $NUGET_API_KEY

pages:
  # DocFX with Mono, .NET Core 3.1 SDK
  image: tizendotnet/tizenfx-build-worker:2.0
  stage: deploy
  only:
    refs:
      - master
    changes:
      - src/**/*
      - docs/**/*
  cache:
    paths:
      - docs/api/
      - docs/obj/
  before_script:
    - ''
  script:
    - docfx docs/docfx.json
  artifacts:
    paths:
      - public/
